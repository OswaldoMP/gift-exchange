<section class="exchange-hub">
    <div class="bg-ornaments">
        <span class="orb orb-1"></span>
        <span class="orb orb-2"></span>
        <span class="orb orb-3"></span>
        <span class="garland"></span>
    </div>

    <header class="hub-header glass">
        <div class="identity">
            <div class="avatar-ring">
                <img [src]="currentUser.avatarUrl || '../../assets/default-avatar.png'" alt="avatar" />
                <span class="status-dot" [class.ready]="isDrawn"></span>
            </div>
            <div>
                <p class="eyebrow">Hola {{ currentUser.name || 'participante' }}</p>
                <h1>Panel del intercambio navide√±o</h1>
                <p>Revisa tus ideas de regalo, solicita el sorteo y mantente al tanto del estado del evento.</p>
            </div>
        </div>

        <div class="header-cards">
            <div class="stat-card">
                <p>Participantes</p>
                <strong>{{ participants.length }}</strong>
                <small>Personas confirmadas</small>
            </div>
            <div class="stat-card">
                <p>Mis regalos</p>
                <strong>{{ currentUser.gifts.length }}/5</strong>
                <small>Ideas registradas</small>
            </div>
            <div class="stat-card status" [class.ready]="isDrawn">
                <p>Estado</p>
                <strong>{{ isDrawn ? 'Sorteo listo' : 'Pendiente' }}</strong>
                <small>{{ isDrawn ? 'Recibiste a tu amigo secreto' : 'A√∫n puedes editar tu lista' }}</small>
            </div>
        </div>

        <div class="header-actions">
            <button class="ghost" *ngIf="isAdminUser()" (click)="goToAdminDashboard()">Panel admin</button>
            <button class="ghost" (click)="signOut()">Cerrar sesi√≥n</button>
            <button class="primary" (click)="requestDraw()" [disabled]="isDrawn">
        {{ isDrawn ? 'Sorteo solicitado' : 'Solicitar sorteo' }}
      </button>
        </div>
    </header>

    <section class="info-banner">
        <article>
            <p>Pr√≥xima actualizaci√≥n</p>
            <h4>{{startEvent()}} ¬∑ {{timeEvent()}}</h4>
            <small>Para recibir el resultado del sorteo.</small>
        </article>
        <article>
            <p>Reglas del juego</p>
            <h4>Presupuesto sugerido {{moneyEvent()}}</h4>
            <small>Incluye enlaces o tiendas para cada idea de regalo.</small>
        </article>
        <article>
            <p>Checklist</p>
            <h4>{{ canAddGift ? 'Agrega m√°s ideas' : 'Lista completa' }}</h4>
            <small>Comparte m√≠nimo tres opciones para inspirar a tu amigo secreto.</small>
        </article>
    </section>

    <main class="dashboard">
        <section class="card gifts">
            <header>
                <div>
                    <p class="eyebrow">Mis ideas</p>
                    <h2>Regalos guardados</h2>
                </div>
                <button *ngIf="canAddGift && !isDrawn" class="primary subtle" (click)="openDialogNewGift()">Agregar idea</button>
            </header>

            <div class="progress-bar">
                <span [style.width.%]="(currentUser.gifts.length / 5) * 100"></span>
                <div class="progress-copy">
                    {{ currentUser.gifts.length }} de 5 ideas registradas
                </div>
            </div>

            <div *ngIf="!currentUser.gifts.length" class="empty-state">
                <p>A√∫n no registras regalos.</p>
                <small>Comienza a√±adiendo una experiencia, un detalle hecho a mano o un enlace de referencia.</small>
            </div>

            <ul class="gift-grid">
                <li *ngFor="let g of currentUser.gifts" (click)="openGift(g)">
                    <div class="gift-chip">
                        <div>
                            <p>{{ g.title }}</p>
                            <small>{{ g.store || g.link || 'Sin referencia' }}</small>
                        </div>
                        <span>üéÅ</span>
                    </div>
                </li>
            </ul>

            <p class="hint">Toca cualquier tarjeta para editarla o eliminarla.</p>
        </section>

        <section class="card participation">
            <ng-container *ngIf="!isDrawn; else assignedView">
                <header>
                    <div>
                        <p class="eyebrow">Equipo</p>
                        <h2>Participantes</h2>
                    </div>
                    <p class="subtitle">Monitorea cu√°ntos regalos carg√≥ cada persona antes del sorteo.</p>
                </header>

                <ul class="participant-list">
                    <li *ngFor="let p of participants">
                        <div class="person">
                            <img [src]="p.avatarUrl || 'assets/default-avatar.png'" alt="avatar" />
                            <div>
                                <p>{{ p.name }}</p>
                                <small>{{ p.gifts.length }} regalos</small>
                            </div>
                        </div>
                        <span class="badge" [class.ready]="p.is_ready">
              {{ p.is_ready ? 'Listo' : 'Pendiente' }}
            </span>
                    </li>
                </ul>
            </ng-container>

            <ng-template #assignedView>
                <header>
                    <div>
                        <p class="eyebrow">Sorteo</p>
                        <h2>Tu amigo secreto</h2>
                    </div>
                    <p class="subtitle">Mant√©n el misterio pero revisa su lista para planear la sorpresa perfecta.</p>
                </header>

                <div *ngIf="myAssignedFriend && wheelAlreadyPlayed; else waiting" class="assigned-card glass">
                    <img [src]="myAssignedFriend.avatarUrl || 'assets/default-avatar.png'" alt="Amigo secreto" />
                    <div>
                        <h3>{{ myAssignedFriend.name }}</h3>
                        <p>{{ myAssignedFriend.gifts.length }} ideas guardadas</p>
                    </div>
                </div>

                <button class="primary wheel-btn" *ngIf="myAssignedFriend && !wheelAlreadyPlayed" (click)="startWheelReveal()">
                  Gira la ruleta y conoce a tu amigo secreto!
                </button>

                <ul *ngIf="myAssignedFriend && wheelAlreadyPlayed" class="gift-grid alt">
                    <li *ngFor="let g of myAssignedFriend.gifts" (click)="openGift(g)">
                        <div class="gift-chip">
                            <div>
                                <p>{{ g.title }}</p>
                                <small>{{ g.store || g.link || 'Sin referencia' }}</small>
                            </div>
                            <span>‚ú®</span>
                        </div>
                    </li>
                </ul>

                <ng-template #waiting>
                    <div class="empty-state">
                        <p>Espera la confirmaci√≥n del sorteo.</p>
                        <small>Te avisaremos en cuanto tu amigo secreto est√© asignado.</small>
                    </div>
                </ng-template>
            </ng-template>
        </section>
    </main>

    <section class="secondary-grid">
        <article class="card highlight">
            <h3>Recordatorio</h3>
            <p>Comparte m√≠nimo tres opciones para inspirar a tu amigo secreto.</p>

            <p>Incluye enlaces o tiendas para cada idea de regalo.</p>
        </article>
    </section>

    <div class="wheel-overlay" *ngIf="showWheelOverlay">
        <div class="wheel-backdrop" (click)="closeWheelOverlay()"></div>
        <div class="wheel-modal glass">
            <button class="modal-close" (click)="closeWheelOverlay(true)">√ó</button>
            <p class="eyebrow">Ruleta</p>
            <h3>As√≠ se decidi√≥ tu amigo secreto</h3>
            <p class="subtitle">Observa el giro y celebra cuando se detenga en tu compa√±ero asignado.</p>
            <div class="wheel-wrapper">
                <div class="wheel-pointer"></div>
                <div class="spin-wheel" [class.spinning]="wheelSpinning" [style.--spin-angle]="wheelRotation + 'deg'" [style.--spin-duration]="wheelDuration + 'ms'" [style.background]="wheelGradient" [style.transform]="'rotate(' + wheelStaticAngle + 'deg)'">
                    <span class="wheel-label" *ngFor="let p of participants; let i = index" [style.transform]="wheelLabelTransform(i)">
                        <span class="wheel-label__text">{{ p.name }}</span>
                    </span>
                </div>
            </div>
            <p class="hint center">La ruleta solo aparecer√° una vez por participante.</p>
        </div>
        <div class="confetti" *ngIf="showConfetti">
            <span *ngFor="let piece of confettiPieces" [style.animation-delay]="(piece * 70) + 'ms'" [style.left]="((piece * 37) % 100) + '%'"></span>
        </div>
    </div>

    <!-- MODAL EDITAR REGALO -->
    <div class="modal" *ngIf="selectedGift">
        <div class="modal-backdrop" (click)="closeGift()"></div>
        <div class="modal-card glass">
            <button class="modal-close" (click)="closeGift()">√ó</button>

            <header>
                <p class="eyebrow">Editar regalo</p>
                <h3>Actualiza la informaci√≥n</h3>
            </header>

            <label class="field">
        <span>Nombre</span>
        <input type="text" [(ngModel)]="selectedGift.title" />
      </label>

            <label class="field">
        <span>Tienda</span>
        <input type="text" [(ngModel)]="selectedGift.store" />
      </label>

            <label class="field">
        <span>Link</span>
        <input type="text" [(ngModel)]="selectedGift.link" />
      </label>

            <div class="modal-actions">
                <button class="ghost" (click)="closeGift()">Cancelar</button>
                <div class="action-group" [class.hidden]="isDrawn">
                    <button class="danger" (click)="removeGift(selectedGift)">Eliminar</button>
                    <button class="primary" (click)="updateGift(selectedGift)">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVO REGALO -->
    <div class="modal" *ngIf="newGift">
        <div class="modal-backdrop" (click)="closeGift()"></div>
        <div class="modal-card glass">
            <button class="modal-close" (click)="closeGift()">√ó</button>

            <header>
                <p class="eyebrow">Nueva idea</p>
                <h3>Describe el regalo</h3>
            </header>

            <label class="field">
        <span>Nombre</span>
        <input type="text" [(ngModel)]="newGift.title" />
      </label>

            <label class="field">
        <span>Tienda</span>
        <input type="text" [(ngModel)]="newGift.store" />
      </label>

            <label class="field">
        <span>Link</span>
        <input type="text" [(ngModel)]="newGift.link" />
      </label>

            <div class="modal-actions">
                <button class="ghost" (click)="closeGift()">Cancelar</button>
                <button class="primary" (click)="addGift(newGift)">Guardar idea</button>
            </div>
        </div>
    </div>
</section>
